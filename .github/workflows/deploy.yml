name: DigiClick AI - Deploy with Cursor Testing

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '20.18.0'
  NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}
  NEXT_PUBLIC_APP_URL: ${{ secrets.NEXT_PUBLIC_APP_URL }}
  NODE_ENV: ${{ secrets.NODE_ENV }}

jobs:
  # Health Check Job
  health-check:
    name: ðŸ” Health Check
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¥ Install dependencies
        run: npm ci

      - name: ðŸŽ¯ Run cursor health check
        run: npm run check:cursor

      - name: ðŸ“Š Upload health report
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: health-check-report
          path: reports/

  # Lint and Format Job
  lint:
    name: ðŸ§¹ Lint & Format
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¥ Install dependencies
        run: npm ci

      - name: ðŸ§¹ Run ESLint
        run: npm run lint

      - name: ðŸŽ¨ Check Prettier formatting
        run: npm run format:check

  # Test Job
  test:
    name: ðŸ§ª Test Suite
    runs-on: ubuntu-latest
    needs: [health-check]
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¥ Install dependencies
        run: npm ci

      - name: ðŸ§ª Run unit tests
        run: npm test

      - name: ðŸŽ¯ Run cursor-specific tests
        run: npm run test:cursor

      - name: ðŸ“Š Upload test coverage
        uses: codecov/codecov-action@v3
        if: always()
        with:
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella

      - name: ðŸ“Š Upload test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: test-results
          path: |
            coverage/
            test-results/

  # Build Job
  build:
    name: ðŸ—ï¸ Build Application
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¥ Install dependencies
        run: npm ci

      - name: ðŸ—ï¸ Build application
        run: npm run build
        env:
          NEXT_PUBLIC_API_URL: ${{ env.NEXT_PUBLIC_API_URL }}
          NEXT_PUBLIC_APP_URL: ${{ env.NEXT_PUBLIC_APP_URL }}

      - name: ðŸ“Š Analyze bundle size
        run: npm run build:analyze
        if: github.event_name == 'pull_request'

      - name: ðŸ“¦ Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: build-files
          path: |
            .next/
            public/
          retention-days: 1

  # Performance Testing Job
  performance:
    name: âš¡ Performance Testing
    runs-on: ubuntu-latest
    needs: [build]
    if: github.event_name == 'pull_request'
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¥ Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: build-files

      - name: ðŸ“¥ Install dependencies
        run: npm ci

      - name: ðŸš€ Start application
        run: npm start &
        env:
          NEXT_PUBLIC_API_URL: ${{ env.NEXT_PUBLIC_API_URL }}
          NEXT_PUBLIC_APP_URL: http://localhost:3000

      - name: â³ Wait for application
        run: npx wait-on http://localhost:3000 --timeout 60000

      - name: ðŸŽ¯ Run Lighthouse CI
        run: npm run performance:test

      - name: ðŸ“Š Upload performance report
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: lighthouse-report
          path: reports/lighthouse.json

  # Deploy to Vercel (Production)
  deploy-vercel:
    name: ðŸš€ Deploy to Vercel
    runs-on: ubuntu-latest
    needs: [build]
    if: github.ref == 'refs/heads/main'
    environment: production
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¥ Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: build-files

      - name: ðŸš€ Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
          working-directory: ./

  # Deploy to Netlify (Production)
  deploy-netlify:
    name: ðŸš€ Deploy to Netlify (Production)
    runs-on: ubuntu-latest
    needs: [build]
    if: github.ref == 'refs/heads/main'
    environment: production
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¥ Install dependencies
        run: npm ci

      - name: ðŸ—ï¸ Build for production
        run: npm run build
        env:
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}
          NEXT_PUBLIC_APP_URL: ${{ secrets.NEXT_PUBLIC_APP_URL }}
          NODE_ENV: ${{ secrets.NODE_ENV }}
          SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
          GOOGLE_ANALYTICS_ID: ${{ secrets.GOOGLE_ANALYTICS_ID }}

      - name: ðŸ” Verify build output
        run: |
          echo "Checking build output..."
          ls -la out/
          echo "Verifying sitemap generation..."
          ls -la public/sitemap.xml
          echo "Checking cursor system files..."
          find out/ -name "*cursor*" -type f | head -5

      - name: ðŸš€ Deploy to Netlify
        uses: nwtgck/actions-netlify@v3.0
        with:
          publish-dir: './out'
          production-branch: main
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: "Deploy DigiClick AI with Context-Aware Cursor System - ${{ github.event.head_commit.message }}"
          enable-pull-request-comment: true
          enable-commit-comment: true
          overwrites-pull-request-comment: true
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

  # Post-Deployment Testing
  post-deploy-test:
    name: ðŸ§ª Post-Deployment Testing
    runs-on: ubuntu-latest
    needs: [deploy-netlify]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¥ Install dependencies
        run: npm ci

      - name: â³ Wait for deployment to be live
        run: |
          echo "Waiting for site to be available..."
          npx wait-on ${{ secrets.NEXT_PUBLIC_APP_URL }} --timeout 300000
          sleep 30

      - name: ðŸŽ¯ Test cursor functionality on live site
        run: |
          echo "Testing cursor context demo page..."
          curl -f ${{ secrets.NEXT_PUBLIC_APP_URL }}/cursor-context-demo || exit 1
          echo "Testing main portfolio page..."
          curl -f ${{ secrets.NEXT_PUBLIC_APP_URL }}/portfolio || exit 1
          echo "Testing sitemap..."
          curl -f ${{ secrets.NEXT_PUBLIC_APP_URL }}/sitemap.xml || exit 1

      - name: ðŸ” Verify cursor system deployment
        run: |
          echo "Checking for cursor-related assets..."
          curl -s ${{ secrets.NEXT_PUBLIC_APP_URL }} | grep -i "cursor" && echo "âœ… Cursor system detected" || echo "âŒ Cursor system not found"

      - name: ðŸ“Š Upload test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: post-deploy-test-results
          path: |
            test-results/
            playwright-report/

  # Comprehensive Notification Job
  notify:
    name: ðŸ“¢ Deployment Notifications
    runs-on: ubuntu-latest
    needs: [deploy-netlify, post-deploy-test, performance-audit]
    if: always()
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“Š Calculate build metrics
        id: metrics
        run: |
          # Calculate build time (approximate)
          BUILD_START_TIME="${{ github.event.head_commit.timestamp }}"
          BUILD_END_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          # Get commit info
          COMMIT_HASH="${{ github.sha }}"
          COMMIT_SHORT="${COMMIT_HASH:0:7}"
          COMMIT_MESSAGE="${{ github.event.head_commit.message }}"
          BRANCH_NAME="${{ github.ref_name }}"

          # Get performance audit results
          PERFORMANCE_RESULT="${{ needs.performance-audit.result }}"
          LIGHTHOUSE_SCORE="${{ needs.performance-audit.outputs.lighthouse_score || '0' }}"
          PERFORMANCE_STATUS="${{ needs.performance-audit.outputs.overall_status || 'unknown' }}"

          # Determine overall status including performance
          if [[ "${{ needs.deploy-netlify.result }}" == "success" && "${{ needs.post-deploy-test.result }}" == "success" && "$PERFORMANCE_STATUS" == "success" ]]; then
            OVERALL_STATUS="success"
            STATUS_EMOJI="âœ…"
            STATUS_TEXT="SUCCESS"
          elif [[ "${{ needs.deploy-netlify.result }}" == "failure" || "${{ needs.post-deploy-test.result }}" == "failure" || "$PERFORMANCE_STATUS" == "failure" ]]; then
            OVERALL_STATUS="failure"
            STATUS_EMOJI="âŒ"
            STATUS_TEXT="FAILURE"
          else
            OVERALL_STATUS="warning"
            STATUS_EMOJI="âš ï¸"
            STATUS_TEXT="WARNING"
          fi

          # Set outputs
          echo "status=$OVERALL_STATUS" >> $GITHUB_OUTPUT
          echo "status_emoji=$STATUS_EMOJI" >> $GITHUB_OUTPUT
          echo "status_text=$STATUS_TEXT" >> $GITHUB_OUTPUT
          echo "commit_hash=$COMMIT_HASH" >> $GITHUB_OUTPUT
          echo "commit_short=$COMMIT_SHORT" >> $GITHUB_OUTPUT
          echo "commit_message=$COMMIT_MESSAGE" >> $GITHUB_OUTPUT
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "build_time=~5 minutes" >> $GITHUB_OUTPUT
          echo "github_run_url=${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_OUTPUT
          echo "lighthouse_score=$LIGHTHOUSE_SCORE" >> $GITHUB_OUTPUT
          echo "performance_status=$PERFORMANCE_STATUS" >> $GITHUB_OUTPUT

      - name: ðŸ“§ Send email notification
        if: always()
        uses: ./.github/actions/email-notify
        with:
          smtp-server: ${{ secrets.SMTP_SERVER || 'smtp.gmail.com' }}
          smtp-port: ${{ secrets.SMTP_PORT || '587' }}
          smtp-username: ${{ secrets.SMTP_USERNAME }}
          smtp-password: ${{ secrets.SMTP_PASSWORD }}
          from-email: ${{ secrets.FROM_EMAIL }}
          to-emails: ${{ secrets.ALERT_EMAIL_RECIPIENTS }}
          status: ${{ steps.metrics.outputs.status }}
          subject: "${{ steps.metrics.outputs.status_emoji }} DigiClick AI Deployment ${{ steps.metrics.outputs.status_text }} - ${{ steps.metrics.outputs.commit_short }}"
          commit-hash: ${{ steps.metrics.outputs.commit_hash }}
          commit-message: ${{ steps.metrics.outputs.commit_message }}
          branch: ${{ steps.metrics.outputs.branch_name }}
          deployment-url: ${{ secrets.NEXT_PUBLIC_APP_URL }}
          build-time: ${{ steps.metrics.outputs.build_time }}
          github-run-url: ${{ steps.metrics.outputs.github_run_url }}
          error-details: ${{ needs.deploy-netlify.result == 'failure' && 'Netlify deployment failed' || needs.post-deploy-test.result == 'failure' && 'Post-deployment tests failed' || '' }}

      - name: ðŸ’¬ Send Slack notification
        if: always()
        uses: ./.github/actions/slack-notify
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          status: ${{ steps.metrics.outputs.status }}
          title: "DigiClick AI Deployment ${{ steps.metrics.outputs.status_text }}"
          message: ${{ steps.metrics.outputs.status == 'success' && format('Deployment completed successfully! Lighthouse Score: {0}/100, Performance: {1}', steps.metrics.outputs.lighthouse_score, steps.metrics.outputs.performance_status) || 'Deployment encountered issues. Check logs for details.' }}
          commit-hash: ${{ steps.metrics.outputs.commit_hash }}
          commit-message: ${{ steps.metrics.outputs.commit_message }}
          branch: ${{ steps.metrics.outputs.branch_name }}
          deployment-url: ${{ secrets.NEXT_PUBLIC_APP_URL }}
          build-time: ${{ steps.metrics.outputs.build_time }}
          github-run-url: ${{ steps.metrics.outputs.github_run_url }}
          error-details: ${{ needs.deploy-netlify.result == 'failure' && 'Netlify deployment failed - check build logs' || needs.post-deploy-test.result == 'failure' && 'Post-deployment verification failed - site may be inaccessible' || '' }}

      - name: ðŸ” Run comprehensive monitoring
        if: steps.metrics.outputs.status == 'success'
        run: |
          echo "ðŸ” Running post-deployment monitoring..."
          node scripts/deployment-monitor.js
        env:
          NEXT_PUBLIC_APP_URL: ${{ secrets.NEXT_PUBLIC_APP_URL }}
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}

      - name: ðŸ“Š Upload monitoring report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: deployment-monitoring-report
          path: |
            reports/
          retention-days: 30

  # Performance Budget Monitoring
  performance-audit:
    name: ðŸš€ Performance Budget Audit
    runs-on: ubuntu-latest
    needs: [deploy-netlify]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¥ Install dependencies
        run: |
          npm ci
          npm install -g @lhci/cli puppeteer

      - name: â³ Wait for deployment to be ready
        run: |
          echo "Waiting for deployment to be fully ready..."
          npx wait-on ${{ secrets.NEXT_PUBLIC_APP_URL }} --timeout 300000
          sleep 60

      - name: ðŸ” Run Lighthouse CI audit
        run: |
          echo "Running Lighthouse CI performance audit..."
          lhci autorun
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          LHCI_BUILD_CONTEXT__CURRENT_HASH: ${{ github.sha }}
          LHCI_BUILD_CONTEXT__COMMIT_TIME: ${{ github.event.head_commit.timestamp }}

      - name: ðŸ–±ï¸ Run cursor system performance audit
        run: |
          echo "Running cursor system performance audit..."
          node scripts/performance-monitor.js
        env:
          NEXT_PUBLIC_APP_URL: ${{ secrets.NEXT_PUBLIC_APP_URL }}

      - name: ðŸ“Š Parse performance results
        id: performance
        run: |
          # Parse Lighthouse results
          if [ -f ".lighthouseci/assertion-results.json" ]; then
            LIGHTHOUSE_SCORE=$(cat .lighthouseci/assertion-results.json | jq -r '.[] | select(.auditProperty == "categories.performance") | .actual * 100' | head -1)
            LIGHTHOUSE_PASSED=$(cat .lighthouseci/assertion-results.json | jq -r 'map(select(.level == "error")) | length == 0')
          else
            LIGHTHOUSE_SCORE="0"
            LIGHTHOUSE_PASSED="false"
          fi

          # Parse custom performance audit
          if [ -f "reports/performance-audit-report.json" ]; then
            PERFORMANCE_STATUS=$(cat reports/performance-audit-report.json | jq -r '.overall')
            VIOLATIONS=$(cat reports/performance-audit-report.json | jq -c '.violations')
            WARNINGS=$(cat reports/performance-audit-report.json | jq -c '.warnings')
          else
            PERFORMANCE_STATUS="unknown"
            VIOLATIONS="[]"
            WARNINGS="[]"
          fi

          # Determine overall performance status
          if [ "$LIGHTHOUSE_PASSED" = "false" ] || [ "$PERFORMANCE_STATUS" = "failure" ]; then
            OVERALL_STATUS="failure"
          elif [ "$PERFORMANCE_STATUS" = "warning" ] || [ "$LIGHTHOUSE_SCORE" -lt 90 ]; then
            OVERALL_STATUS="warning"
          else
            OVERALL_STATUS="success"
          fi

          echo "lighthouse_score=$LIGHTHOUSE_SCORE" >> $GITHUB_OUTPUT
          echo "lighthouse_passed=$LIGHTHOUSE_PASSED" >> $GITHUB_OUTPUT
          echo "performance_status=$PERFORMANCE_STATUS" >> $GITHUB_OUTPUT
          echo "overall_status=$OVERALL_STATUS" >> $GITHUB_OUTPUT
          echo "violations=$VIOLATIONS" >> $GITHUB_OUTPUT
          echo "warnings=$WARNINGS" >> $GITHUB_OUTPUT

      - name: ðŸ“Š Upload Lighthouse reports
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: lighthouse-reports
          path: |
            .lighthouseci/
            reports/
          retention-days: 30

      - name: ðŸš¨ Send performance alerts
        if: always()
        uses: ./.github/actions/performance-notify
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          performance-status: ${{ steps.performance.outputs.overall_status }}
          lighthouse-score: ${{ steps.performance.outputs.lighthouse_score }}
          violations: ${{ steps.performance.outputs.violations }}
          warnings: ${{ steps.performance.outputs.warnings }}
          deployment-url: ${{ secrets.NEXT_PUBLIC_APP_URL }}
          commit-hash: ${{ github.sha }}
          github-run-url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

      - name: ðŸš¨ Send failure alert with details
        if: steps.metrics.outputs.status == 'failure'
        uses: ./.github/actions/slack-notify
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          status: failure
          title: "ðŸš¨ URGENT: DigiClick AI Deployment Failed"
          message: |
            Immediate action required! Deployment has failed and may impact live site.

            **Next Steps:**
            1. Check GitHub Actions logs
            2. Verify Netlify deployment status
            3. Test cursor system functionality
            4. Consider rollback if necessary
          commit-hash: ${{ steps.metrics.outputs.commit_hash }}
          commit-message: ${{ steps.metrics.outputs.commit_message }}
          branch: ${{ steps.metrics.outputs.branch_name }}
          github-run-url: ${{ steps.metrics.outputs.github_run_url }}
          error-details: "Build: ${{ needs.build.result }} | Deploy: ${{ needs.deploy-netlify.result }} | Tests: ${{ needs.post-deploy-test.result }}"
